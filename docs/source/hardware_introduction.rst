.. note::

    こんにちは、SunFounderのRaspberry Pi & Arduino & ESP32愛好家コミュニティへようこそ！Facebook上でRaspberry Pi、Arduino、ESP32についてもっと深く掘り下げ、他の愛好家と交流しましょう。

    **参加する理由は？**

    - **エキスパートサポート**：コミュニティやチームの助けを借りて、販売後の問題や技術的な課題を解決します。
    - **学び＆共有**：ヒントやチュートリアルを交換してスキルを向上させましょう。
    - **独占的なプレビュー**：新製品の発表や先行プレビューに早期アクセスしましょう。
    - **特別割引**：最新製品の独占割引をお楽しみください。
    - **祭りのプロモーションとギフト**：ギフトや祝日のプロモーションに参加しましょう。

    👉 私たちと一緒に探索し、創造する準備はできていますか？[|link_sf_facebook|]をクリックして今すぐ参加しましょう！

ハードウェアの紹介
========================

仕様表
-----------------------------

.. list-table:: 
   :widths: 30 10 10 10 10

   * - パラメータ
     - 最小
     - 典型
     - 最大
     - 単位
   * - バッテリーシャットダウン電流
     - \-
     - \-
     - 60
     - uA
   * - バッテリー静止電流
     - \-
     - 25
     - \-
     - mA
   * - DC-DC出力電圧
     - 5.1957
     - 5.2855
     - 5.3766
     - V
   * - DC-DC過温度保護
     - \-
     - 150
     - \-
     - ℃
   * - バッテリー充電電流
     - \-
     - \-
     - 1
     - A
   * - 充電過温度保護
     - \-
     - 135
     - \-
     - ℃
   * - 入力低電圧切替しきい値
     - 4.54
     - 4.63
     - 4.72
     - V
   * - バランシング電流
     - \-
     - 40
     - \-
     - mA
   * - バランシング作動電圧
     - \-
     - 4.1
     - \-
     - V

概要図
-------------------

.. image:: img/pipower3_pinout.png
  :width: 800
  :align: center

1. :ref:`power_input`: 外部電源入力、バッテリーを充電しながらRaspberry Piに直接電力を供給できます。
2. :ref:`cap_onoff`: シャットダウン状態で外部電源入力が差し込まれたときに自動的に起動するかどうかを選択します。
3. :ref:`cap_sdsig`: シャットダウン信号、ジャンパーキャップでピン26を中央のピンに接続すると、 **SDSIG** がRaspberry PiのGPIO26に接続されます。設定が完了すると、Raspberry PiがシャットダウンするとGPIO26が高電位になり、PiPower 3に電源をオフにするように通知します。
4. :ref:`cap_btn`: 外部電源ボタン用のジャンパー、外部電源ボタンに使用されます。
5. **PWR LED**: 出力状態LED、出力が有効になると点灯します。
6. **BAT LED**: バッテリーが現在電力を供給していることを示すLEDが点灯します。この時、過放電によるダメージを防ぐためにバッテリーの残量を監視する必要があります。
7. :ref:`power_button`: ボードの電源を制御するオンボード電源ボタン：

  * **1回押す**: 出力を有効にします。
  * **2秒間押し続け、中間の2つのバッテリーLEDが点灯したら放す**: i2cを介してシャットダウン要求を送信します。
  * **5秒以上押し続ける**: 直接出力をオフにします。

8. :ref:`battery_indicators`: バッテリーの残量と充電状態を示します。
9. **I2Cコネクタ**: SH1.0 4P端子、 **qwIIC** および **STEMMA QT** に対応。
10. **I2Cピンヘッダ**: 1x4P 2.54ピンヘッダ。
11. **タイプA出力**: 5V出力インターフェース。
12. **5V/GNDピンヘッダ**: 2 x 4P 2.54ピンヘッダ。
13. :ref:`pin_header`: Raspberry Piピンヘッダ、Raspberry Piに直接接続します。
14. :ref:`battery_connector`: XH2.54 3Pバッテリーコネクタ。
15. **警告LED**: バッテリーが逆接続されている場合、2つの赤色LEDが点灯し、バッテリー逆接続の警告を発します。

.. _power_button:

電源ボタン
----------------

.. image:: img/power_button.jpg
  :width: 500
  :align: center

オンボードの電源ボタンでボードの電源を制御します：

* **1回押す**: 出力を有効にします。
* **2秒間押し続け、中間の2つのバッテリーLEDが点灯したら放す**: i2cを介してシャットダウン要求を送信します。
* **5秒以上押し続ける**: 直接出力をオフにします。

.. _battery_indicators:

バッテリーインジケータ
--------------------------------

オンボードの4つのLEDがバッテリーの残量と充電状態を示します。シャットダウン中に充電している場合、インジケータライトは充電が完了するまで充電状態を表示し続けます。

.. image:: img/battery_indicator.jpg
  :width: 500
  :align: center

* **4つのLEDが点灯**: バッテリー >80%
* **3つのLEDが点灯**: 60%< バッテリー <80%
* **2つのLEDが点灯**: 40%< バッテリー <60%
* **1つのLEDが点灯**: 20%< バッテリー <40%
* **最初のLEDが点滅**: バッテリー <20%
* **LEDが順に点灯するサイクル**: 充電中
* **中間の2つのLEDが点滅**: シャットダウン信号を待っています
* **すべてのLEDがオフ**: 電源が入っていないか、スリープモード

.. _power_input:

電源入力
-------------

.. image:: img/power_input.jpg
  :width: 500
  :align: center

Raspberry Pi 5で使用する場合、電源入力は5V/5AをサポートするUSB PDソース（推奨は公式のRaspberry Pi 27W電源）を使用する必要があります。そうでないと、高い電力消費時にバッテリーが充電されず、バッテリーが電力を供給できなくなるまで消耗する可能性があります。

**BAT LED** はバッテリーが外部に電力を供給しているかどうかを確認でき、停電時にはバッテリーが電力を供給し続けることでUPS（無停電電源装置）の役割を果たします。

.. image:: img/bat_led.jpg
  :width: 500
  :align: center

**電力経路**

PiPower 3は電力経路機能を統合しており、自動的に電力経路を切り替えてバッテリーの摩耗を減らし、シームレスに電力を切り替えます。

* 外部電源が接続されている場合、5V出力は直接外部5Vから供給され、オフにすることができます。条件が整えば、外部電源はバッテリーも充電します（充電電流を参照）。
* 電力が切断されると、システムは自動的にバッテリーの降圧出力に切り替わり、停電時にシステムを保護するためにシームレスに切り替わります。

**BAT LED** はバッテリーが外部に電力を供給しているかどうかを確認できます。

.. image:: img/bat_led.jpg
  :width: 500
  :align: center

.. _battery_connector:

バッテリーコネクタ
------------------------
XH2.54 3Pバッテリーコネクタ。

.. image:: img/battery_connector.jpg
  :width: 500
  :align: center


充電に関して
-------------------

**充電電流**

最大充電電流は入力電圧に基づいて調整され、Raspberry Piへの最大電力供給を確保します。

* 電源オン時、充電電流は入力電圧に基づいて動的に調整されます。最大充電電流は1Aであり、入力電圧が4.63V未満の場合、電力入力が不十分と見なされ、充電が無効になります。4.63Vから5.2Vの間では、システムは入力電圧が4.63V以上であることを確保するために充電電流を自動的に調整します。
* 電源オフ時、充電電流は1Aです。

**充電プロセス**

* バッテリーの総電圧が3.7V未満の場合、50mAで充電します。
* バッテリーの総電圧が3.7Vから6Vの間の場合、100mAで充電します。
* バッテリーの総電圧が6Vを超える場合、設定された最大充電電流で充電します。
* バッテリーの総電圧が8.4Vに近づくと、定電圧充電モードに入ります。
* バッテリーが完全に充電され、入力が続く場合、バッテリーの総電圧が8V未満になると充電が再開されます。
* 定電圧モードでは、充電電流が200mA未満の場合、30秒後に充電を停止し、バッテリー電圧が充電停止電圧を上回っているかを確認します。上回っていれば充電を停止し、そうでなければ充電を再開し、30秒後に再度確認します。

**充電バランス機能**

充電中、充電チップは2つのバッテリーセルの電圧を常に監視します。どちらかのセル電圧がバランス作動電圧の4.1Vに達すると、対応する内部バランスMOSが作動し、そのセルの充電電流を減少させます。

バランス停止条件：

#. 両方のバッテリーセル電圧がバランス作動電圧の4.1Vを上回る場合。
#. 通常の充電状態を終了した場合（例：NTC保護、入力過電圧、バッテリーの完全充電）。

**温度保護**

* 充電チップの内部温度が135度を超えると、充電が強制的に停止されます。
* DC-DCチップの内部温度が150度を超えると、DC-DCがシャットダウンされます。

MCU I2C通信
-------------------------------

.. image:: img/i2c_pins.jpg
  :width: 500
  :align: center

I2Cアドレス: 0x5a

オンボードのMCUは、ボードからの様々な信号を収集し、それらをレジスタに格納します。これらのレジスタはI2C経由でアクセスできます。

* :download:`Register Table </_static/pdf/Register Table.pdf>`

レジスタ設定テーブル：

.. image:: img/set_register.png
    :width: 700
    :align: center

.. _cap_onoff:

デフォルトのON/OFF
----------------------

.. image:: img/btn_sdsig_off_on.jpg
  :width: 500
  :align: center

この **ON/OFF** ジャンパーは、シャットダウン後にUSB電源が接続されたときに出力がデフォルトで有効になるかどうかを選択するためのものです。

* ジャンパーキャップが左側にあり、OFFに接続されている場合、シャットダウン後にUSB電源を接続しても出力は有効になりません。
* ジャンパーキャップが右側にあり、ONに接続されている場合、シャットダウン後にUSB電源を接続すると出力が有効になります。

この機能は、プライベートサーバーなど、デフォルトでオンにする必要があるデバイスに通常使用されます。外部で停電が発生した場合、PiPower 3はRaspberry Piにシャットダウンを指示します。次の電源供給を待つ間、PiPower 3は自動的に出力を有効にし、Raspberry Piを起動します。これにより手動操作が不要になります。

この機能は、リモートオン/オフ機能としても使用できます。入力をスマートプラグやスマートスイッチに接続します。シャットダウンパーセンテージを100%に設定します。リモートシャットダウンが必要な場合は、スマートプラグを直接制御して電源を切ります。PiPower 3は停電を検出し、Raspberry Piにシャットダウンを通知してから電源を切ります。リモート電源オンが必要な場合は、スマートスイッチを直接オンにします。PiPowerが電力を検出し、デフォルトで電源オンに設定されているため、Raspberry Piを起動でき、リモートで電源のオン/オフを制御できます。

.. _cap_btn:

BTN
---------

.. image:: img/btn_sdsig_off_on.jpg
  :width: 500
  :align: center

この **BTN** ジャンパーは外部電源ボタン用です。PiPower 3をケース内に設置する必要がある場合、オンボードの電源ボタンを押すことができないかもしれません。この場合、電源のオン/オフを切り替えるために外部ボタンが必要です。自己復帰型スイッチをジャンパーに接続します。これにはタクタイルスイッチやビンテージメタルボタンが使用できます。接続後、外部ボタンをオンボードボタンと同じように押すことができます。

.. _cap_sdsig:

SDSIG
------------

**SDSIG** シャットダウン信号には、ピン26、中間ピン、右側のGNDピンの3つのピンが関与します。

* ピン26をジャンパーキャップで中間ピンに接続すると、SDSIGはRaspberry PiのGPIO26に接続されます。設定後、Raspberry Piがシャットダウンすると、GPIO26ピンがハイに引かれ、SDSIGがハイレベルであることを示し、PiPower 3に電源オフを指示します。
* この機能が不要な場合（例：ArduinoやRaspberry Pi Picoのようなシングルボードコンピュータの場合）、ジャンパーキャップをGNDに接続する必要があります。

.. image:: img/btn_sdsig_off_on.jpg
  :width: 500
  :align: center

**SDSIG** はシャットダウン信号ピンです。このピンをハイに引くと、ホストがシャットダウンし、電源をオフにする必要があることを示します。ローに引くと、ホストが電源オンであることを示します。この機能が不要な場合（例：ArduinoやRaspberry Pi Picoのようなシングルボードコンピュータの場合）、ジャンパーキャップをGNDに接続する必要があります。Raspberry Piを使用する場合は、ジャンパーキャップをピン26に接続し、Raspberry Piに``pipower3``ソフトウェアをインストールします。Raspberry Piがシャットダウンすると、このピンをハイに引き、PiPower 3に電源オフを指示します。

.. _pin_header:

Raspberry Pi用ピンヘッダ
---------------------------

Raspberry Piピンヘッダは、Raspberry Piに直接接続され、I2Cと電源を含みます。Raspberry Piのピン図を参照してください。ヘッダはHATを積み重ねるために使用できますが、I2Cとピン26が接続されていることに注意してください。

.. image:: img/40pin_header.jpg
  :width: 500
  :align: center

.. list-table:: 
   :widths: 15 15
   :header-rows: 1

   * - Raspberry Pi
     - オンボードMCU
   * - SDA
     - SDA
   * - SCL
     - SCL
   * - GPIO26
     - SHUTDOWN
   * - ID_SD
     - ID_EEPROM SDA
   * - ID_SC
     - ID_EEPROM SCL
